{
  "openapi": "3.1.0",
  "info": {
    "title": "Procrastinot",
    "version": "1.0",
    "description": "This is the API for Procrastinot"
  },
  "servers": [
    {
      "url": "http://localhost:5001",
      "description": "dev"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/rooms/{roomId}/session": {
      "patch": {
        "summary": "Update Room Session (action via PATCH)",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/UpdateSessionRequest" },
              "examples": {
                "start": { "value": { "action": "startWork", "durationSec": 1500 } },
                "stop": { "value": { "action": "stop" } }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Session state",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Session" },
                "examples": {
                  "running": {
                    "value": { "state": "running", "startedAt": "2025-09-04T16:00:00Z", "durationSec": 1500 }
                  }
                }
              }
            }
          },
          "400": { "description": "Bad Request" },
          "404": { "description": "Not Found" },
          "409": { "description": "Invalid state transition" }
        }
      }
    },
    "/rooms/{roomId}": {
      "delete": {
        "summary": "Delete Room",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "204": { "description": "No Content" },
          "404": {
            "description": "Not Found",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/Error" } }
            }
          }
        }
      },
      "patch": {
        "summary": "Update Room",
        "description": "Change name and/or mode.",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/UpdateRoomRequest" },
              "examples": {
                "rename": { "value": { "name": "Geometry Jam" } },
                "toggle": { "value": { "mode": "deep" } }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Room" },
                "examples": {
                  "afterRename": {
                    "value": { "id": "r_123", "name": "Geometry Jam", "mode": "pomodoro", "inviteCode": "AB12CD" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad Request",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/Error" } }
            }
          },
          "404": {
            "description": "Not Found",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/Error" } }
            }
          }
        }
      },
      "get": {
        "summary": "Get Room",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Room" },
                "examples": {
                  "happyPath": {
                    "summary": "Typical room",
                    "value": { "id": "r_123", "name": "Algebra Hour", "mode": "pomodoro", "inviteCode": "AB12CD" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Not Found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" },
                "examples": { "nf": { "value": { "message": "roomId not found" } } }
              }
            }
          }
        }
      }
    },
    "/rooms": {
      "post": {
        "summary": "Create Room",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/CreateRoomRequest" },
              "examples": {
                "happyPath": { "value": { "name": "Algebra Hour", "mode": "pomodoro" } }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Room created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Room" },
                "examples": {
                  "happyPath": { "value": { "id": "r_123", "name": "Algebra Hour", "mode": "pomodoro", "inviteCode": "AB12CD" } }
                }
              }
            }
          },
          "400": {
            "description": "Bad Request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" },
                "examples": { "bad": { "value": { "message": "invalid payload" } } }
              }
            }
          }
        }
      },
      "get": {
        "summary": "List Rooms",
        "responses": {
          "200": {
            "description": "Array of Rooms",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Room" } },
                "examples": {
                  "twoRooms": {
                    "value": [
                      { "id": "r_123", "name": "Algebra Hour", "mode": "pomodoro", "inviteCode": "AB12CD" },
                      { "id": "r_456", "name": "Geometry Jam", "mode": "deep", "inviteCode": "XY34ZT" }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
    "/rooms/{roomId}/membership": {
      "post": {
        "summary": "Join a Room",
        "description": "As a student, join a room using the invite code. Idempotent: first join 201, repeat 204.",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "type": "object", "required": ["inviteCode"], "properties": { "inviteCode": { "type": "string", "minLength": 4, "maxLength": 10 } } },
              "examples": { "joinRoom": { "value": { "inviteCode": "AB12CD" } } }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Joined room successfully",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/user" }, "examples": { "joined": { "value": { "uid": "u_123", "displayName": "Alice" } } } }
            }
          },
          "204": { "description": "Already joined" },
          "400": { "description": "Invalid invite code" },
          "404": { "description": "Room not found" }
        }
      },
      "get": {
        "summary": "List membership",
        "description": "List all user currently in the room.",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": {
            "description": "Array of users",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/user" } },
                "examples": {
                  "twomembership": { "value": [ { "uid": "u_123", "displayName": "Alice" }, { "uid": "u_456", "displayName": "Bob" } ] }
                }
              }
            }
          },
          "404": { "description": "Room not found" }
        }
      }
    },
    "/rooms/{roomId}/membership/{userId}": {
      "delete": {
        "summary": "Leave a Room",
        "description": "Remove a user from the room.",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "204": { "description": "Left the room successfully" },
          "404": { "description": "Room or user not found" }
        }
      }
    },

    "/rooms/{roomId}/sessions": {
      "post": {
        "summary": "Start a Session",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/CreateSessionRequest" }
            }
          }
        },
        "responses": {
          "200": { "description": "Session created", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SessionDetail" } } } },
          "400": { "description": "Room not found" }
        }
      }
    },
    "/rooms/{roomId}/sessions/{sessionId}/users": {
      "post": {
        "summary": "Join a Session",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "sessionId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/JoinSessionRequest" } } } },
        "responses": {
          "200": { "description": "Joined session", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UserTasks" } } } },
          "400": { "description": "Invalid request" }
        }
      }
    },
    "/rooms/{roomId}/sessions/{sessionId}/users/{userId}": {
      "patch": {
        "summary": "Track Progress",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "sessionId", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UpdateTasksRequest" } } } },
        "responses": { "200": { "description": "Progress updated" } }
      }
    },
    "/rooms/{roomId}/sessions/{sessionId}": {
      "get": {
        "summary": "Get Session Status",
        "parameters": [
          { "name": "roomId", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "sessionId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "Session and users", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SessionStatus" } } } }
        }
      }
    },
    "/users/{userId}/rooms": {
      "get": {
        "summary": "See My Rooms",
        "parameters": [
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "Rooms the user belongs to", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Room" } } } } }
        }
      }
    },
    "/users/{userId}/friends": {
      "get": {
        "summary": "See Focus Friends",
        "parameters": [
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "List of friends", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Friend" } } } } }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Session": {
        "type": "object",
        "properties": {
          "state": { "type": "string", "enum": ["idle", "running", "break"] },
          "startedAt": { "type": "string", "format": "date-time", "nullable": true },
          "durationSec": { "type": "integer", "nullable": true }
        }
      },
      "UpdateSessionRequest": {
        "type": "object",
        "oneOf": [
          {
            "description": "Start a work session",
            "required": ["action", "durationSec"],
            "properties": {
              "action": { "type": "string", "enum": ["startWork"] },
              "durationSec": { "type": "integer", "minimum": 60 }
            }
          },
          {
            "description": "Stop session",
            "required": ["action"],
            "properties": { "action": { "type": "string", "enum": ["stop"] } }
          }
        ]
      },
      "CreateRoomRequest": {
        "type": "object",
        "required": ["name", "mode"],
        "properties": {
          "name": { "type": "string", "minLength": 1, "maxLength": 60 },
          "mode": { "type": "string", "enum": ["pomodoro", "deep"] }
        }
      },
      "UpdateRoomRequest": {
        "type": "object",
        "properties": {
          "name": { "type": "string", "minLength": 1, "maxLength": 60 },
          "mode": { "type": "string", "enum": ["pomodoro", "deep"] }
        },
        "additionalProperties": false
      },
      "Room": {
        "type": "object",
        "required": ["id", "name", "mode", "inviteCode"],
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "mode": { "type": "string", "enum": ["pomodoro", "deep"] },
          "inviteCode": { "type": "string" }
        }
      },
      "Error": {
        "type": "object",
        "required": ["message"],
        "properties": { "message": { "type": "string" } }
      },
      "user": {
        "type": "object",
        "required": ["uid", "displayName"],
        "properties": {
          "uid": { "type": "string" },
          "displayName": { "type": "string" }
        }
      },
      "CreateSessionRequest": {
        "type": "object",
        "required": ["owner", "name", "startTime", "mode", "duration"],
        "properties": {
          "owner": { "type": "string" },
          "name": { "type": "string" },
          "startTime": { "type": "string", "format": "date-time" },
          "mode": { "type": "string", "enum": ["pomodoro", "deep"] },
          "duration": { "type": "integer" },
          "description": { "type": "string" }
        }
      },
      "SessionDetail": {
        "type": "object",
        "properties": {
          "sessionId": { "type": "string" },
          "owner": { "type": "string" },
          "name": { "type": "string" },
          "startTime": { "type": "string", "format": "date-time" },
          "mode": { "type": "string", "enum": ["pomodoro", "deep"] },
          "duration": { "type": "integer" },
          "description": { "type": "string" }
        }
      },
      "JoinSessionRequest": {
        "type": "object",
        "properties": {
          "tasks": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": { "type": "string" }
              }
            }
          }
        }
      },
      "UserTasks": {
        "type": "object",
        "properties": {
          "tasks": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "taskId": { "type": "string" },
                "name": { "type": "string" },
                "complete": { "type": "boolean" }
              }
            }
          }
        }
      },
      "UpdateTasksRequest": {
        "type": "object",
        "properties": {
          "tasks": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "taskId": { "type": "string" },
                "complete": { "type": "boolean" }
              }
            }
          }
        }
      },
      "SessionStatus": {
        "type": "object",
        "properties": {
          "session": { "$ref": "#/components/schemas/SessionDetail" },
          "users": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/UserTasks" }
          }
        }
      },
      "Friend": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "status": { "type": "string" },
          "activeSessions": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/SessionDetail" }
          }
        }
      }
    },
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    }
  }
}